name: Deploy to WP Engine
env:
  WPE_SSHG_KEY_PRIVATE: ${{ secrets.WPE_SSHG_KEY_PRIVATE }}
  WPE_INSTALL_NAME: sagetestd
  THEME_NAME: roots-theme
on:
  push:
    branches:
      - main
jobs:
  js-build:
    runs-on: ubuntu-latest
    steps:
      - name: Check out the git repo
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v3
        with:
          node-version: 16.14.1

      - name: Install js/css dependencies
        uses: borales/actions-yarn@v4
        with:
          dir: wp-content/themes/${{ env.THEME_NAME }}
          cmd: install

      - name: Build js/css
        uses: borales/actions-yarn@v4
        with:
          dir: wp-content/themes/${{ env.THEME_NAME }}
          cmd: build

      - name: Clean up node modules (not needed to deploy)
        run: rm -rf wp-content/themes/${{ env.THEME_NAME }}/node_modules

      - name: Deploy to WPE
        uses: wpengine/github-action-wpe-site-deploy@v3
        with:
          SCRIPT: post-deploy.sh
          WPE_ENV: ${{ env.WPE_INSTALL_NAME }}

  php-build:
    runs-on: ubuntu-latest
    steps:
      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: 8.2
      
      - name: Check out the git repo
        uses: actions/checkout@v4

      - name: Run composer install in theme directory
        run: cd wp-content/themes/${{ env.THEME_NAME }} && composer install && cd -

      - name: Deploy to wpengine.com
        uses: wpengine/github-action-wpe-site-deploy@v3
        with:
          SCRIPT: post-deploy.sh
          WPE_SSHG_KEY_PRIVATE: b3BlbnNzaC1rZXktdjEAAAAABG5vbmUAAAAEbm9uZQAAAAAAAAABAAAAMwAAAAtzc2gtZWQyNTUxOQAAACCqR2EzGJ9XE2CfYNkskluYBvNdyJuJQIQNj5oDndDyRgAAAJiD+568g/uevAAAAAtzc2gtZWQyNTUxOQAAACCqR2EzGJ9XE2CfYNkskluYBvNdyJuJQIQNj5oDndDyRgAAAEA/BtH2knJWG46P1ncphSjr/R/IImzcoKhkBIjbTDhr+apHYTMYn1cTYJ9g2SySW5gG813Im4lAhA2PmgOd0PJGAAAAFWpheWJlQERFU0tUT1AtSFAzT01CNA==
          WPE_ENV: ${{ env.WPE_INSTALL_NAME }}
    # steps:
    # - uses: actions/checkout@v4

    # - name: GitHub Action Deploy to WP Engine
    #   uses: wpengine/github-action-wpe-site-deploy@v3
    #   with:
    #     # Deploy vars
    #     WPE_SSHG_KEY_PRIVATE: ${{ secrets.WPE_SSHG_KEY_PRIVATE }}
    #     WPE_ENV: ${{ env.WPE_INSTALL_NAME }}
    #     # Deploy Options
    #     REMOTE_PATH: "wp-content/"
    #     FLAGS: -azvr --inplace --delete --include-from config/include.txt --exclude=".*" --exclude-from config/exclude.txt
    #     PHP_LINT: TRUE
    #     SCRIPT: wp-content/config/post-deploy.sh
    # runs-on: ubuntu-latest
    # container: gjrdiesel/composer-80:alpine
    # steps:
    #   - name: Check out the git repo
    #     uses: actions/checkout@v4

    #   - name: Run composer install in theme directory
    #     run: cd wp-content/themes/${{ env.THEME_NAME }} && composer install && cd -

    #   - name: Deploy to wpengine.com
    #     uses: wpengine/github-action-wpe-site-deploy@v3
    #     with:
    #       SCRIPT: post-deploy.sh
    #       WPE_ENV: ${{ env.WPE_INSTALL_NAME }}
